@page "/"
@inject IGraphService GraphService
@rendermode InteractiveServer

<PageTitle>Home</PageTitle>

<div class="grid grid-cols-6 gap-4">
    <div class="col-span-1">
        <div class="grid grid-cols-6 gap-4 border-2 p-2 rounded-2xl border-blue-500 bg-gray-200">
            <label class="col-span-1">Title</label>
            <input type="text" @bind="_queryTitle" class="border col-span-5 bg-white"/>
            <label class="col-span-1">Author</label>
            <select @bind="_queryAuthor" class="border col-span-5 bg-white">
                <option></option>
                @if (_authors != null)
                {
                    @foreach (var author in _authors)
                    {
                        <option value="@author.Id">@author.Name</option>
                    }
                }
            </select>
            <label class="col-span-1">Library</label>
            <select @bind="_queryLibrary" class="border col-span-5 bg-white">
                <option></option>
                @if (_libraries != null)
                {
                    @foreach (var library in _libraries)
                    {
                        <option value="@library.Id">@library.Name</option>
                    }
                }
            </select>
            <button
                class="col-span-2 col-start-5 mt-1 mb-1 font-bold py-2 px-4 rounded bg-blue-500 text-white hover:bg-blue-700"
                @onclick="GetBooks"
                data-testid="get-books-button">
                Get Books
            </button>
        </div>
    </div>
    <div class="col-span-5 border-2 p-2 rounded-2xl border-blue-500 bg-gray-200">
        @if (_books != null)
        {
            <div class="flex">
            @foreach (var book in _books)
            {
                <BookCard AuthorName="@book.AuthorName" BookTitle="@book.Title" LibraryName="@book.LibraryName" />
            }
            </div>
        }
    </div>
    <div class="col-span-1">
        <div class="grid grid-cols-6 gap-4 border-2 p-2 rounded-2xl border-blue-500 bg-gray-200">
            <label class="col-span-1">Title</label>
            <input type="text" @bind="_title" class="border col-span-5 bg-white" data-testid="create-book-title"/>
            <label class="col-span-1">Author</label>
            <select @bind="_authorId" class="border col-span-5 bg-white" data-testid="create-book-author">
                <option></option>
                @if (_authors != null)
                {
                    @foreach (var author in _authors)
                    {
                        <option value="@author.Id">@author.Name</option>
                    }
                }
            </select>
            <label class="col-span-1">Library</label>
            <select @bind="_libraryId" class="border col-span-5 bg-white" data-testid="create-book-library">
                <option></option>
                @if (_libraries != null)
                {
                    @foreach (var library in _libraries)
                    {
                        <option value="@library.Id">@library.Name</option>
                    }
                }
            </select>
            <button
                class="col-span-2 col-start-5 mt-1 mb-1 font-bold py-2 px-4 rounded bg-blue-500 text-white hover:bg-blue-700"
                @onclick="AddBook"
                data-testid="create-book-button">
                Add Book
            </button>
        </div>
    </div>
    <div class="col-span-5 border-2 p-2 rounded-2xl border-blue-500 bg-gray-200">
        <ul>
            @if (_book != null)
            {
                <BookCard AuthorName="@_book.AuthorName" BookTitle="@_book.Title" LibraryName="@_book.LibraryName" />
            }
        </ul>
    </div>
</div>

@code {
    List<Book>? _books;
    List<Library>? _libraries;
    List<Author>? _authors;
    Book? _book;

    string _authorId = null!;
    string _libraryId = null!;
    string _title = null!;
    string? _queryTitle;
    string? _queryAuthor;
    string? _queryLibrary;

    protected override async Task OnInitializedAsync()
    {
        _libraries = await GraphService.GetLibraries();
        _authors = await GraphService.GetAuthors();
    }

    async Task GetBooks()
    {
        _books = await GraphService.GetBooks(_queryTitle, _queryAuthor, _queryLibrary);
    }

    async Task AddBook()
    {
        var id = await GraphService.AddBook(_title, _authorId, _libraryId);
        await GetBookById(id);
    }

    async Task GetBookById(string id)
    {
        _book = await GraphService.GetBookById(id);
    }
}